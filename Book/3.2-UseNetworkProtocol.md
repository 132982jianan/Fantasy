# 3.2-使用网络协议 - UseNetworkProtocol

## 客户端

客户端需要跟服务器通讯需要先通过Scene.Connect创建一个Session（会话）。

连接成功后可以通过Session给服务器发送各种类型消息。
### Session.Send

Send方法只有一个参数，这个参数代表要发送给服务器的协议。

```c#
// 这里发送了一个C2G_TestMessage协议给服务器
Session.Send(new C2G_TestMessage() { Tag = "Hello C2G_TestMessage" });
```

### Session.Call

Call方法只有一个参数，这个参数代表要发送给服务器的PRC的请求协议。

会返回一个服务器返回给客户端的消息

```c#
// 这里用C2G_TestRequest发送一个RPC消息给服务器
// 服务器处理完成后、会C2G_TestRequest个协议定义的返回类型返回一个G2C_TestResponse
// 如果定义这个协议的返回类型、在上篇03_定义网络协议里已经提到过了、可以翻过去看一下
var response = (G2C_TestResponse)await _session.Call(new C2G_TestRequest()
{
     Tag = "Hello C2G_TestRequest"
});
Text.text = $"收到G2C_TestResponse Tag = {response.Tag}";
```

## 服务器

### Message

用于接收客户端发送的普通协议，需要定义个类继承Message<接收的网络协议类型>

```c#
// 这里我创建了一个C2G_TestMessageHandler并且继承了Message<C2G_TestMessage>
// Message<C2G_TestMessage>代表这个类是负责接收C2G_TestMessage的消息
// 当客户端发送C2G_TestMessage的消息会执行下面的Run方法。
// Run方法有两个参数
// Session:表示服务器当前跟客户端的会话，在客户端断开之前这个Session一直存在。
// 也就是再发送一个消息还是这个session
// message:收到客户端发送消息的内容
public sealed class C2G_TestMessageHandler : Message<C2G_TestMessage>
{
    protected override async FTask Run(Session session, C2G_TestMessage message)
    {
        Log.Debug($"Receive C2G_TestMessage Tag={message.Tag}");
        await FTask.CompletedTask;
    }
}
```

### MessageRPC

用于接收客户端发送的RPC协议，需要定义个类继承MessageRPC<请求协议, 返回协议>

```c#
// 这里我创建了一个C2G_TestRequestHandler并且继承了MessageRPC<C2G_TestRequest, G2C_TestResponse>
// MessageRPC<C2G_TestRequest, G2C_TestResponse>代表这里类负责接收C2G_TestRequest的请求消息
// G2C_TestResponse代表是要返回给客户端的消息协议类型
// 当客户端发送了C2G_TestRequest消息给服务器，服务器会执行下面的Run方法
// Run方法有四个参数
// Session:表示服务器当前跟客户端的会话，在客户端断开之前这个Session一直存在。
// request:收到客户端发送请求消息的内容
// response:需要返回给客户端的消息，这个消息已经实例化了，可以直接给字段进行赋值。
// reply:通知服务器马上把response消息发送给客户端，如果不手动调用会再这个方法结束后自动调用。
public sealed class C2G_TestRequestHandler : MessageRPC<C2G_TestRequest, G2C_TestResponse>
{
    protected override async FTask Run(Session session, C2G_TestRequest request, G2C_TestResponse response, Action reply)
    {
        Log.Debug($"Receive C2G_TestRequest Tag = {request.Tag}");
        response.Tag = "Hello G2C_TestResponse";
        await FTask.CompletedTask;
    }
}
```

